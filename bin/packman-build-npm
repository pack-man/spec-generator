#!/bin/bash -e 
#===============================================================================
#          FILE: packman-build-package
#         USAGE: ./packman-build-package
#   DESCRIPTION: checkout the metadata configuration for the package from the repo
#                and prepare the git ENV 
#       OPTIONS: ---
#  REQUIREMENTS: ---
#          BUGS: ---
#         NOTES: ---
#        AUTHOR: Jess Portnoy (), <jess@packman.io>
#  ORGANIZATION: Packman.
#       CREATED: 03/11/2016 12:47:11 PM GMT
#      REVISION:  ---
#===============================================================================

#set -o nounset                              # Treat unset variables as an error

DIRNAME=`dirname $0`
NEEDED_FILES="$DIRNAME/packman-functions.rc"
for NEEDED_FILE in $NEEDED_FILES;do
        if [ ! -r $NEEDED_FILE ];then
                printf "Missing $NEEDED_FILE. Something is wrong with your ENV. Exiting."
                exit 2
        fi
        . $NEEDED_FILE
done
if [ $# -lt 5 ];then
        printf "Usage: $0 <path/to/package.rc> <api id> <api key> <job id> <package id>\n"
        exit 1
fi

trap 'trap_handler ${LINENO} $?' ERR
PACKAGE_RC=$1
if [ ! -r "$PACKAGE_RC" ];then
	printf "Could not read $PACKAGE_RC. Exiting."
	exit 3
fi
. $PACKAGE_RC
PACKMAN_API_ID=$2
PACKMAN_API_KEY=$3
JOB_ID=$4
PACKAGE_ID=$5
export PACKMAN_API_ID PACKMAN_API_KEY JOB_ID PACKAGE_ID

update_job_api $JOB_ID $JOB_IN_PROGRESS
update_package_status_api $PACKAGE_ID $PACKAGE_BUILD_IN_PROGRESS
BRANCH=$PACKAGE_NAME-$PACKAGE_VERSION
cd /etc/packman/packman-packages-meta/$PACKMAN_SPACE/$BRANCH
if [ -r package.json ];then
        mv package.json package.json.orig
fi
# we need to generate one
sed "s#@@PACKAGE_NAME@@#$PACKAGE_NAME#g" /etc/packman/packman-packages-meta/spec_skels/npm.skel > package.json
sed -i "s#@@PACKAGE_VERSION@@#$PACKAGE_VERSION#g"  package.json
DESCRIPTION=`get_package_description_api $PACKAGE_ID|sed "s^\"^'^g"`
sed -i "s^@@PACKAGE_DESCRIPTION@@^$DESCRIPTION^g"  package.json
sed -i "s^@@PACKMAN_REPO@@^https://github.com/packdaddy/$PACKMAN_SPACE^g"  package.json
sed -i "s^@@PROJECT_URL@@^$PROJECT_URL^g"  package.json

#for @@TEST_SCRIPT@@ @@POST_INST_SCRIPT@@ @@MAIN_SCRIPT@@
# see if we already have them in the original package.json and if they exist, if so, use them, if not
# main is server.js if exists or index.js if exists, if neither exist, FATAL.

#if [ -r ]
